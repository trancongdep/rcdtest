<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kiểm tra Vùng Đặc tính</title>
    <!-- Tải Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Sử dụng font Inter */
        html, body {
            height: 100%;
        }
        body {
            font-family: 'Inter', sans-serif;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        /* Style cho kết quả */
        #result.zone-green { background-color: #90ee90; color: #003300; }
        #result.zone-yellow { background-color: #f0e68c; color: #554a00; }
        #result.zone-blue { background-color: #a0d8f0; color: #002a40; }
        #result.zone-red { background-color: #ffb6c1; color: #5c000e; }
        
        /* Đảm bảo canvas co giãn mà không làm hỏng bố cục */
        canvas {
            display: block;
            touch-action: none;
        }
    </style>
</head>
<body class="bg-gray-100 p-4">

    <!-- Thẻ div chính với lề tự động và chiều rộng tối đa -->
    <div class="bg-white p-6 sm:p-8 rounded-2xl shadow-xl w-full max-w-5xl mx-auto">
        <h1 class="text-2xl sm:text-3xl font-bold text-center text-gray-800 mb-6">
            Kiểm tra Vùng làm việc của RCD
        </h1>
        <p class="text-center text-gray-600 mb-8">
            Nhập dòng điện (trục hoành) và thời gian (trục tung) để xem điểm giao nhau trên biểu đồ.
        </p>

        <!-- Thay đổi từ lg:grid-cols-2 thành md:grid-cols-2 -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 items-start">
            
            <!-- Bảng điều khiển nhập liệu -->
            <div class="space-y-6">
                <!-- Nhập Dòng điện -->
                <div>
                    <label for="current" class="block text-sm font-medium text-gray-700 mb-1">
                        Dòng điện cắt (I)
                    </label>
                    <div class="flex rounded-lg shadow-sm">
                        <input type="number" id="current" value="30" class="flex-1 block w-full min-w-0 rounded-none rounded-l-lg border-gray-300 p-3 focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="Ví dụ: 30">
                        <select id="currentUnit" class="inline-flex items-center px-3 rounded-r-lg border border-l-0 border-gray-300 bg-gray-50 text-gray-500 sm:text-sm">
                            <option value="uA">µA</option>
                            <option value="mA" selected>mA</option>
                            <option value="A">A</option>
                        </select>
                    </div>
                </div>

                <!-- Nhập Thời gian -->
                <div>
                    <label for="time" class="block text-sm font-medium text-gray-700 mb-1">
                        Thời gian cắt (T)
                    </label>
                    <div class="flex rounded-lg shadow-sm">
                        <input type="number" id="time" value="100" class="flex-1 block w-full min-w-0 rounded-none rounded-l-lg border-gray-300 p-3 focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="Ví dụ: 100">
                        <select id="timeUnit" class="inline-flex items-center px-3 rounded-r-lg border border-l-0 border-gray-300 bg-gray-50 text-gray-500 sm:text-sm">
                            <option value="ms" selected>ms</option>
                            <option value="s">s</option>
                        </select>
                    </div>
                </div>

                <!-- Nút Kiểm tra -->
                <button id="checkButton" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg shadow-lg hover:bg-blue-700 transition duration-300 ease-in-out">
                    Kiểm tra và Vẽ
                </button>

                <!-- Vùng Kết quả -->
                <div id="result" class="text-center p-4 rounded-lg text-xl sm:text-2xl font-bold transition-all duration-300">
                    Nhập giá trị để xem kết quả...
                </div>
            </div>

            <!-- Biểu đồ Canvas (Thay đổi) -->
            <!-- Thêm w-full max-w-lg mx-auto md:max-w-none để kiểm soát kích thước trên di động -->
            <div class="bg-gray-50 border border-gray-200 rounded-lg overflow-hidden w-full max-w-lg mx-auto md:max-w-none">
                <!-- Xóa width/height, dùng class để responsive -->
                <canvas id="chartCanvas" class="w-full aspect-square"></canvas>
            </div>
        </div>
    </div>

    <script>
        // Định nghĩa các hằng số cho đường biên
        const BOUNDARY_SLOPE = -1.7;
        const BOUNDARY_INTERCEPT = 5.0;
        const AC1_LIMIT_MA = 0.5; // 500 µA

        // Thiết lập canvas
        const canvas = document.getElementById('chartCanvas');
        const ctx = canvas.getContext('2d');

        // *** THAY ĐỔI QUAN TRỌNG ***
        // Đặt độ phân giải BÊN TRONG (buffer) của canvas.
        // CSS sẽ tự động co giãn kích thước HIỂN THỊ của canvas này.
        // Sử dụng 1000x1000 để có độ sắc nét cao (tốt cho retina).
        canvas.width = 1000;
        canvas.height = 1000;

        // Các biến này giờ sẽ là 1000, không phải 500
        const canvasWidth = canvas.width;
        const canvasHeight = canvas.height;

        // Giới hạn biểu đồ (logarithmic) - không đổi
        const I_MIN_MA = 0.1; // 100 µA
        const I_MAX_MA = 10000; // 10 A
        const T_MIN_MS = 1; // 1 ms
        const T_MAX_MS = 10000; // 10 s

        const LOG_I_MIN = Math.log10(I_MIN_MA);
        const LOG_I_MAX = Math.log10(I_MAX_MA);
        const LOG_T_MIN = Math.log10(T_MIN_MS);
        const LOG_T_MAX = Math.log10(T_MAX_MS);

        // Hàm chuyển đổi giá trị sang tọa độ canvas (Logarithmic) - không đổi
        function mapLogX(i_mA) {
            const logI = Math.log10(Math.max(I_MIN_MA, Math.min(I_MAX_MA, i_mA)));
            return ((logI - LOG_I_MIN) / (LOG_I_MAX - LOG_I_MIN)) * canvasWidth;
        }

        function mapLogY(t_ms) {
            const logT = Math.log10(Math.max(T_MIN_MS, Math.min(T_MAX_MS, t_ms)));
            return canvasHeight - ((logT - LOG_T_MIN) / (LOG_T_MAX - LOG_T_MIN)) * canvasHeight;
        }

        // Hàm vẽ biểu đồ nền
        function drawGraph(point = null) {
            ctx.clearRect(0, 0, canvasWidth, canvasHeight);
            
            // --- 1. Vẽ các Vùng ---
            ctx.fillStyle = '#f0e68c'; // Vùng Vàng (AC-3/4)
            ctx.fillRect(0, 0, canvasWidth, canvasHeight);

            // Vùng Xanh (AC-2)
            ctx.fillStyle = '#90ee90'; 
            ctx.beginPath();
            const topBoundaryI = Math.pow(10, (LOG_T_MAX - BOUNDARY_INTERCEPT) / BOUNDARY_SLOPE);
            const bottomBoundaryI = Math.pow(10, (LOG_T_MIN - BOUNDARY_INTERCEPT) / BOUNDARY_SLOPE);
            ctx.moveTo(mapLogX(AC1_LIMIT_MA), mapLogY(T_MAX_MS));
            ctx.lineTo(mapLogX(AC1_LIMIT_MA), mapLogY(T_MIN_MS));
            ctx.lineTo(mapLogX(bottomBoundaryI), mapLogY(T_MIN_MS));
            ctx.lineTo(mapLogX(topBoundaryI), mapLogY(T_MAX_MS));
            ctx.closePath();
            ctx.fill();

            // Vùng Xanh nhạt (AC-1)
            ctx.fillStyle = '#a0d8f0'; 
            ctx.fillRect(0, 0, mapLogX(AC1_LIMIT_MA), canvasHeight);

            // --- 2. Vẽ Lưới Logarit ---
            // Tăng kích thước font một chút cho rõ nét hơn trên buffer lớn
            ctx.strokeStyle = '#ddd';
            ctx.fillStyle = '#555';
            ctx.font = '20px Inter'; // Tăng font size (vì buffer là 1000x1000)
            ctx.lineWidth = 1;
            ctx.setLineDash([4, 6]); // Tăng dash cho dễ nhìn

            // Lưới trục I (Dọc)
            const iLabels = [
                { val: 0.1, text: '100µA' }, { val: 0.5, text: '500µA' }, { val: 1, text: '1mA' }, 
                { val: 5, text: '5mA' }, { val: 10, text: '10mA' }, { val: 30, text: '30mA' }, 
                { val: 100, text: '100mA' }, { val: 500, text: '500mA' }, { val: 1000, text: '1A' }, 
                { val: 5000, text: '5A' }, { val: 10000, text: '10A' }
            ];
            iLabels.forEach(label => {
                const x = mapLogX(label.val);
                ctx.beginPath();
                ctx.moveTo(x, 0);
                ctx.lineTo(x, canvasHeight);
                ctx.stroke();
                // Điều chỉnh vị trí text cho font lớn hơn
                ctx.fillText(label.text, x + 5, canvasHeight - 10);
            });

            // Lưới trục T (Ngang)
            const tLabels = [
                { val: 1, text: '1ms' }, { val: 10, text: '10ms' }, { val: 100, text: '100ms' }, 
                { val: 500, text: '500ms' }, { val: 1000, text: '1s' }, { val: 2000, text: '2s' },
                { val: 5000, text: '5s' }, { val: 10000, text: '10s' }
            ];
            tLabels.forEach(label => {
                const y = mapLogY(label.val);
                ctx.beginPath();
                ctx.moveTo(0, y);
                ctx.lineTo(canvasWidth, y);
                ctx.stroke();
                ctx.fillText(label.text, 5, y - 5);
            });
            
            ctx.setLineDash([]); // Reset dash

            // --- 3. Vẽ Đường biên AC-2/AC-3 ---
            ctx.strokeStyle = 'green';
            ctx.lineWidth = 6; // Tăng độ dày cho dễ thấy
            ctx.beginPath();
            ctx.moveTo(mapLogX(bottomBoundaryI), mapLogY(T_MIN_MS));
            ctx.lineTo(mapLogX(topBoundaryI), mapLogY(T_MAX_MS));
            ctx.stroke();

            // --- 4. Vẽ Điểm Giao (nếu có) ---
            if (point) {
                const x = mapLogX(point.i_mA);
                const y = mapLogY(point.t_ms);

                ctx.strokeStyle = '#ff0000'; // Màu đỏ
                ctx.lineWidth = 4; // Tăng độ dày
                
                // Đường gióng ngang
                ctx.beginPath();
                ctx.moveTo(0, y);
                ctx.lineTo(canvasWidth, y);
                ctx.stroke();

                // Đường gióng dọc
                ctx.beginPath();
                ctx.moveTo(x, 0);
                ctx.lineTo(x, canvasHeight);
                ctx.stroke();

                // Dấu X tại điểm
                ctx.lineWidth = 8; // Tăng độ dày
                const crossSize = 12; // Tăng kích thước
                ctx.beginPath();
                ctx.moveTo(x - crossSize, y - crossSize);
                ctx.lineTo(x + crossSize, y + crossSize);
                ctx.moveTo(x - crossSize, y + crossSize);
                ctx.lineTo(x + crossSize, y - crossSize);
                ctx.stroke();
            }
        }

        // Hàm kiểm tra vùng - không đổi logic
        function checkZone(i_mA, t_ms) {
            if (i_mA < AC1_LIMIT_MA) {
                return { 
                    zone: 'AC-1', 
                    className: 'zone-blue', 
                    text: 'VÙNG AC-1 (An toàn, không cảm nhận)' 
                };
            }

            const log_I = Math.log10(i_mA);
            const log_T_input = Math.log10(t_ms);
            
            const log_T_boundary = (BOUNDARY_SLOPE * log_I) + BOUNDARY_INTERCEPT;

            if (log_T_input < log_T_boundary) {
                return { 
                    zone: 'AC-2', 
                    className: 'zone-green', 
                    text: 'VÙNG XANH (AC-2 - An toàn)' 
                };
            } else {
                const log_T_boundary_AC3_4 = -2.17 * log_I + 7.34;
                if(log_T_input < log_T_boundary_AC3_4) {
                    return { 
                        zone: 'AC-3', 
                        className: 'zone-yellow', 
                        text: 'VÙNG VÀNG (AC-3 - Nguy hiểm)' 
                    };
                } else {
                     return { 
                        zone: 'AC-4', 
                        className: 'zone-red', 
                        text: 'VÙNG ĐỎ (AC-4 - Rất nguy hiểm)' 
                    };
                }
            }
        }

        // Hàm xử lý chính - không đổi logic
        function handleCheck() {
            const current = parseFloat(document.getElementById('current').value);
            const currentUnit = document.getElementById('currentUnit').value;
            const time = parseFloat(document.getElementById('time').value);
            const timeUnit = document.getElementById('timeUnit').value;
            const resultDiv = document.getElementById('result');

            if (isNaN(current) || isNaN(time) || current <= 0 || time <= 0) {
                resultDiv.textContent = 'Vui lòng nhập giá trị hợp lệ.';
                resultDiv.className = 'text-center p-4 rounded-lg text-xl sm:text-2xl font-bold bg-red-100 text-red-700';
                drawGraph(null);
                return;
            }

            let i_mA = current;
            if (currentUnit === 'uA') i_mA = current / 1000;
            if (currentUnit === 'A') i_mA = current * 1000;

            let t_ms = time;
            if (timeUnit === 's') t_ms = time * 1000;

            const result = checkZone(i_mA, t_ms);

            resultDiv.textContent = result.text;
            resultDiv.className = `text-center p-4 rounded-lg text-xl sm:text-2xl font-bold transition-all duration-300 ${result.className}`;

            drawGraph({ i_mA, t_ms });
        }

        // Gắn sự kiện
        document.getElementById('checkButton').addEventListener('click', handleCheck);

        // Vẽ biểu đồ lần đầu khi tải trang
        window.addEventListener('load', () => {
            // Thêm một chút delay để đảm bảo font đã tải (hoặc layout ổn định)
            setTimeout(() => {
                drawGraph(null);
                handleCheck(); // Tự động chạy với giá trị mặc định
            }, 100); 
        });

        // Thêm sự kiện resize để vẽ lại biểu đồ (tùy chọn, nhưng tốt)
        // Lưu ý: Việc này chỉ cần thiết nếu kích thước buffer thay đổi
        // Vì chúng ta dùng CSS để scale, nên thực ra là không cần
        // Nhưng nếu sau này bạn muốn_resize_ buffer, bạn sẽ cần nó.
        // window.addEventListener('resize', handleCheck); // Bỏ comment nếu muốn vẽ lại khi resize

    </script>
</body>
</html>
