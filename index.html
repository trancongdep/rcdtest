<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kiểm tra Vùng Đặc tính</title>
    <!-- Tải Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Sử dụng font Inter */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Style cho kết quả */
        #result.zone-green { background-color: #90ee90; color: #003300; }
        #result.zone-yellow { background-color: #f0e68c; color: #554a00; }
        #result.zone-blue { background-color: #a0d8f0; color: #002a40; }
        #result.zone-red { background-color: #ffb6c1; color: #5c000e; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">

    <div class="bg-white p-6 sm:p-8 rounded-2xl shadow-xl w-full max-w-5xl">
        <h1 class="text-2xl sm:text-3xl font-bold text-center text-gray-800 mb-6">
            Kiểm tra Vùng Đặc tính Dòng điện và thời gian của RCD
        </h1>
        <p class="text-center text-gray-600 mb-8">
            Nhập dòng điện (trục hoành) và thời gian (trục tung) để xem điểm giao nhau trên biểu đồ.
        </p>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            
            <!-- Bảng điều khiển nhập liệu -->
            <div class="space-y-6">
                <!-- Nhập Dòng điện -->
                <div>
                    <label for="current" class="block text-sm font-medium text-gray-700 mb-1">
                        Dòng điện cắt (I)
                    </label>
                    <div class="flex rounded-lg shadow-sm">
                        <input type="number" id="current" value="30" class="flex-1 block w-full min-w-0 rounded-none rounded-l-lg border-gray-300 p-3 focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="Ví dụ: 30">
                        <select id="currentUnit" class="inline-flex items-center px-3 rounded-r-lg border border-l-0 border-gray-300 bg-gray-50 text-gray-500 sm:text-sm">
                            <option value="uA">µA</option>
                            <option value="mA" selected>mA</option>
                            <option value="A">A</option>
                        </select>
                    </div>
                </div>

                <!-- Nhập Thời gian -->
                <div>
                    <label for="time" class="block text-sm font-medium text-gray-700 mb-1">
                        Thời gian cắt (T)
                    </label>
                    <div class="flex rounded-lg shadow-sm">
                        <input type="number" id="time" value="100" class="flex-1 block w-full min-w-0 rounded-none rounded-l-lg border-gray-300 p-3 focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="Ví dụ: 100">
                        <select id="timeUnit" class="inline-flex items-center px-3 rounded-r-lg border border-l-0 border-gray-300 bg-gray-50 text-gray-500 sm:text-sm">
                            <option value="ms" selected>ms</option>
                            <option value="s">s</option>
                        </select>
                    </div>
                </div>

                <!-- Nút Kiểm tra -->
                <button id="checkButton" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg shadow-lg hover:bg-blue-700 transition duration-300 ease-in-out">
                    Kiểm tra và Vẽ
                </button>

                <!-- Vùng Kết quả -->
                <div id="result" class="text-center p-4 rounded-lg text-xl sm:text-2xl font-bold transition-all duration-300">
                    Nhập giá trị để xem kết quả...
                </div>
            </div>

            <!-- Biểu đồ Canvas -->
            <div class="bg-gray-50 border border-gray-200 rounded-lg overflow-hidden">
                <canvas id="chartCanvas" width="500" height="500"></canvas>
            </div>
        </div>
    </div>

    <script>
        // Định nghĩa các hằng số cho đường biên
        // Dựa trên phân tích biểu đồ log-log, đường biên AC-2/AC-3 xấp xỉ:
        // log10(T_ms) = -1.7 * log10(I_mA) + 5.0
        const BOUNDARY_SLOPE = -1.7;
        const BOUNDARY_INTERCEPT = 5.0;
        const AC1_LIMIT_MA = 0.5; // 500 µA

        // Thiết lập canvas
        const canvas = document.getElementById('chartCanvas');
        const ctx = canvas.getContext('2d');
        const canvasWidth = canvas.width;
        const canvasHeight = canvas.height;

        // Giới hạn biểu đồ (logarithmic)
        const I_MIN_MA = 0.1; // 100 µA
        const I_MAX_MA = 10000; // 10 A
        const T_MIN_MS = 1; // 1 ms
        const T_MAX_MS = 10000; // 10 s

        const LOG_I_MIN = Math.log10(I_MIN_MA);
        const LOG_I_MAX = Math.log10(I_MAX_MA);
        const LOG_T_MIN = Math.log10(T_MIN_MS);
        const LOG_T_MAX = Math.log10(T_MAX_MS);

        // Hàm chuyển đổi giá trị sang tọa độ canvas (Logarithmic)
        function mapLogX(i_mA) {
            const logI = Math.log10(Math.max(I_MIN_MA, Math.min(I_MAX_MA, i_mA)));
            return ((logI - LOG_I_MIN) / (LOG_I_MAX - LOG_I_MIN)) * canvasWidth;
        }

        function mapLogY(t_ms) {
            const logT = Math.log10(Math.max(T_MIN_MS, Math.min(T_MAX_MS, t_ms)));
            return canvasHeight - ((logT - LOG_T_MIN) / (LOG_T_MAX - LOG_T_MIN)) * canvasHeight;
        }

        // Hàm vẽ biểu đồ nền
        function drawGraph(point = null) {
            ctx.clearRect(0, 0, canvasWidth, canvasHeight);
            
            // --- 1. Vẽ các Vùng ---
            
            // Vùng Vàng (AC-3/4) - Vẽ toàn bộ trước
            ctx.fillStyle = '#f0e68c'; // Màu vàng nhạt
            ctx.fillRect(0, 0, canvasWidth, canvasHeight);

            // Vùng Xanh (AC-2) - Vẽ đè lên
            ctx.fillStyle = '#90ee90'; // Màu xanh lá
            ctx.beginPath();
            // Tìm điểm giao của đường biên với trục Y (T_MAX)
            // 4 = -1.7 * logI + 5 => logI = 1/1.7 = 0.588 => I = 3.87 mA
            const topBoundaryI = Math.pow(10, (LOG_T_MAX - BOUNDARY_INTERCEPT) / BOUNDARY_SLOPE);
            // Tìm điểm giao của đường biên với trục X (T_MIN)
            // 0 = -1.7 * logI + 5 => logI = 5/1.7 = 2.94 => I = 870 mA
            const bottomBoundaryI = Math.pow(10, (LOG_T_MIN - BOUNDARY_INTERCEPT) / BOUNDARY_SLOPE);

            ctx.moveTo(mapLogX(AC1_LIMIT_MA), mapLogY(T_MAX_MS)); // Góc trên trái (của AC-2)
            ctx.lineTo(mapLogX(AC1_LIMIT_MA), mapLogY(T_MIN_MS)); // Góc dưới trái
            ctx.lineTo(mapLogX(bottomBoundaryI), mapLogY(T_MIN_MS)); // Góc dưới phải (theo đường biên)
            ctx.lineTo(mapLogX(topBoundaryI), mapLogY(T_MAX_MS)); // Góc trên phải (theo đường biên)
            ctx.closePath();
            ctx.fill();

            // Vùng Xanh nhạt (AC-1) - Vẽ đè lên
            ctx.fillStyle = '#a0d8f0'; // Màu xanh nhạt
            ctx.fillRect(0, 0, mapLogX(AC1_LIMIT_MA), canvasHeight);

            // --- 2. Vẽ Lưới Logarit ---
            ctx.strokeStyle = '#ddd';
            ctx.fillStyle = '#555';
            ctx.font = '10px Inter';
            ctx.lineWidth = 1;
            ctx.setLineDash([2, 3]);

            // Lưới trục I (Dọc)
            const iLabels = [
                { val: 0.1, text: '100µA' }, { val: 0.5, text: '500µA' }, { val: 1, text: '1mA' }, 
                { val: 5, text: '5mA' }, { val: 10, text: '10mA' }, { val: 30, text: '30mA' }, 
                { val: 100, text: '100mA' }, { val: 500, text: '500mA' }, { val: 1000, text: '1A' }, 
                { val: 5000, text: '5A' }, { val: 10000, text: '10A' }
            ];
            iLabels.forEach(label => {
                const x = mapLogX(label.val);
                ctx.beginPath();
                ctx.moveTo(x, 0);
                ctx.lineTo(x, canvasHeight);
                ctx.stroke();
                ctx.fillText(label.text, x + 3, canvasHeight - 5);
            });

            // Lưới trục T (Ngang)
            const tLabels = [
                { val: 1, text: '1ms' }, { val: 10, text: '10ms' }, { val: 100, text: '100ms' }, 
                { val: 500, text: '500ms' }, { val: 1000, text: '1s' }, { val: 2000, text: '2s' },
                { val: 5000, text: '5s' }, { val: 10000, text: '10s' }
            ];
            tLabels.forEach(label => {
                const y = mapLogY(label.val);
                ctx.beginPath();
                ctx.moveTo(0, y);
                ctx.lineTo(canvasWidth, y);
                ctx.stroke();
                ctx.fillText(label.text, 5, y - 3);
            });
            
            ctx.setLineDash([]); // Reset dash

            // --- 3. Vẽ Đường biên AC-2/AC-3 ---
            ctx.strokeStyle = 'green';
            ctx.lineWidth = 3;
            ctx.beginPath();
            ctx.moveTo(mapLogX(bottomBoundaryI), mapLogY(T_MIN_MS));
            ctx.lineTo(mapLogX(topBoundaryI), mapLogY(T_MAX_MS));
            ctx.stroke();

            // --- 4. Vẽ Điểm Giao (nếu có) ---
            if (point) {
                const x = mapLogX(point.i_mA);
                const y = mapLogY(point.t_ms);

                ctx.strokeStyle = '#ff0000'; // Màu đỏ
                ctx.lineWidth = 2;
                
                // Đường gióng ngang
                ctx.beginPath();
                ctx.moveTo(0, y);
                ctx.lineTo(canvasWidth, y);
                ctx.stroke();

                // Đường gióng dọc
                ctx.beginPath();
                ctx.moveTo(x, 0);
                ctx.lineTo(x, canvasHeight);
                ctx.stroke();

                // Dấu X tại điểm
                ctx.lineWidth = 4;
                ctx.beginPath();
                ctx.moveTo(x - 6, y - 6);
                ctx.lineTo(x + 6, y + 6);
                ctx.moveTo(x - 6, y + 6);
                ctx.lineTo(x + 6, y - 6);
                ctx.stroke();
            }
        }

        // Hàm kiểm tra vùng
        function checkZone(i_mA, t_ms) {
            if (i_mA < AC1_LIMIT_MA) {
                return { 
                    zone: 'AC-1', 
                    className: 'zone-blue', 
                    text: 'VÙNG AC-1 (An toàn, không cảm nhận)' 
                };
            }

            const log_I = Math.log10(i_mA);
            const log_T_input = Math.log10(t_ms);
            
            // Tính giá trị T trên đường biên tại dòng điện I
            const log_T_boundary = (BOUNDARY_SLOPE * log_I) + BOUNDARY_INTERCEPT;

            if (log_T_input < log_T_boundary) {
                // Phía dưới/bên trái đường biên
                return { 
                    zone: 'AC-2', 
                    className: 'zone-green', 
                    text: 'VÙNG XANH (AC-2 - An toàn)' 
                };
            } else {
                // Phía trên/bên phải đường biên
                // Trong biểu đồ gốc, đây là AC-3 và AC-4
                // Theo yêu cầu của bạn, chúng ta gọi nó là "vàng"
                
                // Chúng ta có thể thêm logic cho AC-4 nếu muốn, nhưng hãy giữ nó đơn giản
                // Dựa trên biểu đồ, đường biên AC-3/AC-4.1
                // P1(100mA, 1000ms), P2(500mA, 30ms)
                // m = (log(30)-log(1000)) / (log(500)-log(100)) = (1.48 - 3) / (2.7 - 2) = -1.52 / 0.7 = -2.17
                // c = 3 - 2*(-2.17) = 7.34
                const log_T_boundary_AC3_4 = -2.17 * log_I + 7.34;

                if(log_T_input < log_T_boundary_AC3_4) {
                    return { 
                        zone: 'AC-3', 
                        className: 'zone-yellow', 
                        text: 'VÙNG VÀNG (AC-3 - Nguy hiểm)' 
                    };
                } else {
                     return { 
                        zone: 'AC-4', 
                        className: 'zone-red', 
                        text: 'VÙNG ĐỎ (AC-4 - Rất nguy hiểm)' 
                    };
                }
            }
        }

        // Hàm xử lý chính
        function handleCheck() {
            const current = parseFloat(document.getElementById('current').value);
            const currentUnit = document.getElementById('currentUnit').value;
            const time = parseFloat(document.getElementById('time').value);
            const timeUnit = document.getElementById('timeUnit').value;
            const resultDiv = document.getElementById('result');

            if (isNaN(current) || isNaN(time) || current <= 0 || time <= 0) {
                resultDiv.textContent = 'Vui lòng nhập giá trị hợp lệ.';
                resultDiv.className = 'text-center p-4 rounded-lg text-xl sm:text-2xl font-bold bg-red-100 text-red-700';
                drawGraph(null);
                return;
            }

            // Chuẩn hóa giá trị về mA và ms
            let i_mA = current;
            if (currentUnit === 'uA') i_mA = current / 1000;
            if (currentUnit === 'A') i_mA = current * 1000;

            let t_ms = time;
            if (timeUnit === 's') t_ms = time * 1000;

            // Kiểm tra vùng
            const result = checkZone(i_mA, t_ms);

            // Cập nhật UI
            resultDiv.textContent = result.text;
            resultDiv.className = `text-center p-4 rounded-lg text-xl sm:text-2xl font-bold transition-all duration-300 ${result.className}`;

            // Vẽ lại biểu đồ với điểm
            drawGraph({ i_mA, t_ms });
        }

        // Gắn sự kiện
        document.getElementById('checkButton').addEventListener('click', handleCheck);

        // Vẽ biểu đồ lần đầu khi tải trang
        window.addEventListener('load', () => {
            drawGraph(null);
            // Tự động chạy kiểm tra với giá trị mặc định
            handleCheck();
        });

    </script>
</body>
</html>
